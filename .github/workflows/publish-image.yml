name: Build and publish Docker image

on:
  push:
    branches: [ main ]

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          # Prefer a Personal Access Token (PAT) set in `GHCR_PAT`. If not provided,
          # fall back to the built-in `github.token` (requires `permissions: packages: write`).
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT || github.token }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/botdsviht:latest
          file: ./Dockerfile
          context: .

      - name: Image details
        run: |
          echo "Image published: ghcr.io/${{ github.repository_owner }}/botdsviht:latest"

      - name: Deploy to server via SSH (optional)
        if: ${{ secrets.SSH_HOST && secrets.SSH_PRIVATE_KEY }}
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script: |
            set -e
            echo "[deploy] Connected to $(hostname)"
            # Prefer repo deploy/docker-compose if present on host
            if [ -f ./deploy/docker-compose.yml ] || [ -f /srv/viht/deploy/docker-compose.yml ]; then
              if [ -f ./deploy/docker-compose.yml ]; then
                cd ./deploy || true
              else
                cd /srv/viht/deploy || true
              fi
              docker-compose pull || echo "[deploy] docker-compose pull failed"
              docker-compose up -d --build || echo "[deploy] docker-compose up failed"
              exit 0
            fi

            # Fallback: pull image and recreate container
            IMAGE=ghcr.io/${GITHUB_REPOSITORY_OWNER}/botdsviht:latest
            docker pull "$IMAGE" || echo "[deploy] docker pull failed"
            if docker ps -a --format '{{.Names}}' | grep -q '^viht-vpn-bot$'; then
              docker stop viht-vpn-bot || true
              docker rm viht-vpn-bot || true
            fi
            docker run -d --name viht-vpn-bot --restart unless-stopped --env-file ./.env -v $(pwd)/logs:/usr/src/app/logs "$IMAGE" || echo "[deploy] docker run failed"
